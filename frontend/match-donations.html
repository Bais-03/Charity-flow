<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Match Donations</title>
</head>
<body>
    <a href="admin-dashboard.html">â¬… Back to Dashboard</a>
  <h2>Match Donations</h2>
  <div id="donationList"></div>

  <script>
    (async function () {
      const token = localStorage.getItem("adminToken");

      const [donationsRes, needsRes] = await Promise.all([
        fetch("http://localhost:5001/api/donations", {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch("http://localhost:5001/api/ngos/needs", {
          headers: { Authorization: `Bearer ${token}` }
        })
      ]);

      const donations = await donationsRes.json();
      const ngoNeeds = await needsRes.json();

      const acceptedDonations = donations.filter(d => d.status === "Accepted");

      const container = document.getElementById("donationList");

      acceptedDonations.forEach(d => {
        const needsOptions = ngoNeeds.map(n => `
          <option value="${n.ngoId}|${n.requestIndex}">
            ${n.ngoName} wants ${n.itemName} (${n.itemType}) x${n.quantity}
          </option>
        `).join('');

        const div = document.createElement("div");
        div.innerHTML = `
          <h4>${d.itemName} (${d.itemType})</h4>
          <img src="http://localhost:5001/${d.photo}" width="150" />
          <p>Quantity: ${d.quantity}</p>
          <p>User: ${d.userId?.name} - ${d.userId?.email}</p>
          <select id="need-${d._id}">
            <option value="">--Select NGO--</option>
            ${needsOptions}
          </select>
          <button onclick="matchDonation('${d._id}')">Match</button>
          <hr/>
        `;
        container.appendChild(div);
      });
    })();

    async function matchDonation(donationId) {
      const token = localStorage.getItem("adminToken");
      const select = document.getElementById(`need-${donationId}`);
      const value = select.value;

      if (!value) return alert("Please select an NGO need.");

      const [ngoId, requestIndex] = value.split("|");

      const res = await fetch(`http://localhost:5001/api/donations/${donationId}/match-ngo`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ ngoId, requestIndex })
      });

      const data = await res.json();
      alert(data.message);
      location.reload();
    }
  </script>
</body>
</html>
