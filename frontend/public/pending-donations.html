<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pending Donations</title>
  <link rel="stylesheet" href="pending-donations.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="../admindashboard.html" class="back-link">Back to Dashboard</a>
      <h2 class="page-title">Pending Donations</h2>
      <div></div>
    </div>
    
    <div id="donationList"></div>
  </div>

  <script>
    (async function loadDonations() {
      const token = localStorage.getItem("adminToken");
      if (!token) {
        showError("Admin token not found. Please login again.");
        return;
      }

      const container = document.getElementById("donationList");
      showLoading(container);

      try {
        const res = await fetch("http://localhost:5001/api/donations", {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error(`Server responded with ${res.status}`);
        }

        const donations = await res.json();
        const pending = donations.filter(d => d.status === "Pending");

        if (pending.length === 0) {
          showEmptyState(container);
          return;
        }

        renderDonations(container, pending);
      } catch (error) {
        console.error('Fetch error:', error);
        showErrorState(container, error.message);
      }
    })();

    function renderDonations(container, donations) {
      container.innerHTML = '';
      donations.forEach(d => {
        const div = document.createElement("div");
        div.className = "donation-card";
        div.dataset.donationId = d._id;
        div.innerHTML = `
          <span class="status-badge">Pending Review</span>
          <h3 class="donation-header">${d.itemName} (${d.itemType})</h3>
          <img src="http://localhost:5001/${d.photo}" class="donation-image" alt="${d.itemName}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
          <div class="donation-details">
            <p><strong>Quantity:</strong> ${d.quantity}</p>
            <p><strong>Donated by:</strong> ${d.userId?.name || 'Anonymous'}</p>
            <p><strong>Contact:</strong> ${d.userId?.email || 'Not provided'}</p>
          </div>
          <div class="action-buttons">
            <button class="action-button accept-button" data-action="accept">
              <i class="fas fa-check"></i> Accept
            </button>
            <button class="action-button reject-button" data-action="reject">
              <i class="fas fa-times"></i> Reject
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    document.addEventListener('click', async function(event) {
      const button = event.target.closest('.action-button');
      if (!button) return;

      const card = button.closest('.donation-card');
      if (!card) return;

      const donationId = card.dataset.donationId;
      const action = button.dataset.action;
      const status = action === 'accept' ? 'Accepted' : 'Rejected';

      try {
        const token = localStorage.getItem("adminToken");
        if (!token) {
          throw new Error("Session expired. Please login again.");
        }

        showProcessing(card, status);

        const response = await fetch(`http://localhost:5001/api/donations/${donationId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `Server responded with ${response.status}`);
        }

        const data = await response.json();
        showSuccess(card, status, data.message);
      } catch (error) {
        console.error('Update error:', error);
        showErrorOnCard(card, error.message);
      }
    });

    // Helper functions
    function showLoading(container) {
      container.innerHTML = `
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading donations...</p>
        </div>
      `;
    }

    function showEmptyState(container) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-check-circle"></i>
          <h3>No Pending Donations</h3>
          <p>All donations have been processed.</p>
        </div>
      `;
    }

    function showErrorState(container, message) {
      container.innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error Loading Donations</h3>
          <p>${message}</p>
          <button class="action-button retry-button" onclick="window.location.reload()">
            <i class="fas fa-sync-alt"></i> Try Again
          </button>
        </div>
      `;
    }

    function showProcessing(card, status) {
      card.innerHTML = `
        <div class="processing-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>${status === 'Accepted' ? 'Accepting' : 'Rejecting'} donation...</p>
        </div>
      `;
    }

    function showSuccess(card, status, message) {
      card.innerHTML = `
        <div class="success-state">
          <i class="fas fa-check-circle" style="color: ${status === 'Accepted' ? 'var(--primary)' : 'var(--secondary)'}"></i>
          <h3>Donation ${status}</h3>
          <p>${message}</p>
          <button class="action-button continue-button" onclick="window.location.reload()">
            <i class="fas fa-redo"></i> Continue
          </button>
        </div>
      `;
    }

    function showErrorOnCard(card, message) {
      const originalContent = card.innerHTML;
      card.innerHTML = `
        <div class="error-card-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>${message}</p>
          <button class="action-button retry-button" onclick="this.parentElement.outerHTML = \`${originalContent.replace(/`/g, '\\`')}\`">
            <i class="fas fa-sync-alt"></i> Retry
          </button>
        </div>
      `;
    }
  </script>
</body>
</html>